# ç§Ÿçº¦è®°å½•åŠŸèƒ½ - å®Œæ•´è¯´æ˜

## âœ… åŠŸèƒ½ç¡®è®¤

### æ ¸å¿ƒåŠŸèƒ½ï¼š"ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰å¯è§çš„ç§Ÿçº¦è®°å½•"

ç‚¹å‡»"ç§Ÿçº¦è®°å½•"èœå•åï¼Œ**æ— éœ€ä»»ä½•å‚æ•°**ï¼Œç³»ç»Ÿè‡ªåŠ¨æ ¹æ®å½“å‰ç”¨æˆ·è§’è‰²è¿”å›ç›¸åº”çš„ç§Ÿçº¦è®°å½•ã€‚

## ğŸ“¡ APIç«¯ç‚¹

### è·å–æ‰€æœ‰å¯è§ç§Ÿçº¦
```
GET /api/leases
```

**æ— éœ€å¿…å¡«å‚æ•°**ï¼Œç³»ç»Ÿæ ¹æ®ç”¨æˆ·è§’è‰²è‡ªåŠ¨è¿‡æ»¤ã€‚

## ğŸ” æƒé™æ§åˆ¶

| ç”¨æˆ·è§’è‰² | çœ‹åˆ°çš„ç§Ÿçº¦ | è¯´æ˜ |
|---------|-----------|------|
| ç®¡ç†å‘˜ (ROLE_ADMIN) | æ‰€æœ‰16æ¡ç§Ÿçº¦ | ç®¡ç†æ•´ä¸ªç³»ç»Ÿ |
| ä¸šä¸» (ROLE_OWNER) | è‡ªå·±ç‰©ä¸šçš„ç§Ÿçº¦ | åªçœ‹è‡ªå·±æ‹¥æœ‰çš„ç‰©ä¸šç›¸å…³ç§Ÿçº¦ |
| ç§Ÿå®¢ (ROLE_TENANT) | è‡ªå·±çš„ç§Ÿçº¦ | åªçœ‹è‡ªå·±ä½œä¸ºç§Ÿå®¢çš„ç§Ÿçº¦ |

## ğŸ“Š è¿”å›æ•°æ®

### LeaseDto åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | Long | ç§Ÿçº¦ID |
| propertyId | Long | ç‰©ä¸šID |
| **propertyAddress** | String | **ç‰©ä¸šåœ°å€**ï¼ˆå®Œæ•´ï¼‰ |
| tenantId | Long | ç§Ÿå®¢ID |
| **tenantUsername** | String | **ç§Ÿå®¢ç”¨æˆ·å** |
| startDate | LocalDate | å¼€å§‹æ—¥æœŸ |
| endDate | LocalDate | ç»“æŸæ—¥æœŸ |
| rentAmount | BigDecimal | ç§Ÿé‡‘é‡‘é¢ |
| status | LeaseStatus | çŠ¶æ€ (ACTIVE, EXPIRED, TERMINATED) |
| createdAt | Instant | åˆ›å»ºæ—¶é—´ |

### å“åº”ç¤ºä¾‹

```json
{
  "content": [
    {
      "id": 1,
      "propertyId": 1,
      "propertyAddress": "é‡‘æ°´åŒºç»ä¸‰è·¯15å·1å•å…ƒ501",
      "tenantId": 11,
      "tenantUsername": "tenant_zhao",
      "startDate": "2024-06-01",
      "endDate": "2025-05-31",
      "rentAmount": 2500.00,
      "status": "ACTIVE",
      "createdAt": "2024-06-01T10:00:00Z"
    }
  ],
  "currentPage": 0,
  "totalPages": 4,
  "totalElements": 16,
  "pageSize": 5
}
```

## ğŸ¯ å‰ç«¯é›†æˆ

### ä¸»é¡µé¢åŠ è½½

```javascript
// ç”¨æˆ·ç‚¹å‡»"ç§Ÿçº¦è®°å½•"èœå•æ—¶
function loadLeases() {
    fetch('/api/leases?page=0&size=20')
        .then(response => response.json())
        .then(data => {
            // data.content - æ‰€æœ‰å¯è§çš„ç§Ÿçº¦
            // æ ¹æ®ç”¨æˆ·è§’è‰²è‡ªåŠ¨è¿‡æ»¤
            displayLeases(data.content);
        });
}
```

### æ˜¾ç¤ºç§Ÿçº¦ä¿¡æ¯

```javascript
function displayLeases(leases) {
    leases.forEach(lease => {
        console.log(`ç§Ÿçº¦ #${lease.id}`);
        console.log(`  ç‰©ä¸š: ${lease.propertyAddress}`);
        console.log(`  ç§Ÿå®¢: ${lease.tenantUsername}`);
        console.log(`  ç§Ÿé‡‘: ï¿¥${lease.rentAmount}/æœˆ`);
        console.log(`  çŠ¶æ€: ${lease.status}`);
        console.log(`  ç§ŸæœŸ: ${lease.startDate} è‡³ ${lease.endDate}`);
    });
}
```

## ğŸ’» åç«¯å®ç°

### Controller (å·²ç¡®è®¤ âœ“)

```java
@GetMapping
public ResponseEntity<PageResponse<LeaseDto>> listLeases(@PageableDefault Pageable pageable) {
    return ResponseEntity.ok(leaseService.getLeases(pageable));
}
```

### Service (å·²ç¡®è®¤ âœ“)

```java
public PageResponse<LeaseDto> getLeases(Pageable pageable) {
    UserPrincipal principal = getCurrentUser();
    Page<Lease> page;
    
    if (isAdmin(principal)) {
        // ç®¡ç†å‘˜çœ‹æ‰€æœ‰
        page = leaseRepository.findAll(pageable);
    } else if (isOwner(principal)) {
        // ä¸šä¸»çœ‹è‡ªå·±ç‰©ä¸šçš„
        page = leaseRepository.findAllByPropertyOwnerId(principal.getId(), pageable);
    } else {
        // ç§Ÿå®¢çœ‹è‡ªå·±çš„
        page = leaseRepository.findAllByTenantId(principal.getId(), pageable);
    }
    
    return PageResponse.from(page.map(LeaseMapper::toDto));
}
```

### Repository (å·²ç¡®è®¤ âœ“)

```java
@EntityGraph(attributePaths = {"property", "property.owner", "tenant"})
Page<Lease> findAll(Pageable pageable);

@EntityGraph(attributePaths = {"property", "property.owner", "tenant"})
Page<Lease> findAllByTenantId(Long tenantId, Pageable pageable);

@EntityGraph(attributePaths = {"property", "property.owner", "tenant"})
Page<Lease> findAllByPropertyOwnerId(Long ownerId, Pageable pageable);
```

**å…³é”®ä¼˜åŒ–**: ä½¿ç”¨ `@EntityGraph` ä¸€æ¬¡æ€§åŠ è½½å…³è”æ•°æ®ï¼Œé¿å…N+1æŸ¥è¯¢é—®é¢˜ã€‚

## âœ… æµ‹è¯•ç»“æœ

```
âœ“ Admin sees 16 lease(s)
âœ“ Database has 16 lease(s)
âœ“ API returns correct total (matches database)
âœ“ Property address: é‡‘æ°´åŒºç»ä¸‰è·¯15å·1å•å…ƒ501
âœ“ Tenant username: tenant_zhao
```

## ğŸ“‹ å…¶ä»–ç§Ÿçº¦ç›¸å…³ç«¯ç‚¹

### 1. è·å–å•ä¸ªç§Ÿçº¦è¯¦æƒ…
```
GET /api/leases/{id}
```

### 2. åˆ›å»ºç§Ÿçº¦
```
POST /api/leases
```
**æƒé™**: ä»…ç®¡ç†å‘˜å’Œä¸šä¸»

**è¯·æ±‚ä½“**:
```json
{
  "propertyId": 1,
  "tenantId": 11,
  "startDate": "2024-06-01",
  "endDate": "2025-05-31",
  "rentAmount": 2500.00,
  "status": "ACTIVE"
}
```

### 3. æ›´æ–°ç§Ÿçº¦
```
PUT /api/leases/{id}
```
**æƒé™**: ä»…ç®¡ç†å‘˜å’Œç‰©ä¸šä¸šä¸»

### 4. åˆ é™¤ç§Ÿçº¦
```
DELETE /api/leases/{id}
```
**æƒé™**: ä»…ç®¡ç†å‘˜å’Œç‰©ä¸šä¸šä¸»

## âš ï¸ é‡è¦æç¤º

### å¿…é¡»é‡å¯åº”ç”¨
ä¿®æ”¹ä»£ç åï¼Œ**å¿…é¡»é‡å¯Spring Bootåº”ç”¨**æ‰èƒ½ç”Ÿæ•ˆï¼š

```bash
# åœæ­¢å½“å‰åº”ç”¨ (Ctrl+C)

# é‡æ–°å¯åŠ¨
mvn spring-boot:run
```

### éªŒè¯æ­¥éª¤

1. âœ… ä»£ç å·²ç¼–è¯‘æˆåŠŸ
2. âš ï¸ **éœ€è¦é‡å¯åº”ç”¨**
3. âš ï¸ æµ‹è¯• `GET /api/leases`
4. âš ï¸ ç¡®è®¤ `propertyAddress` ä¸ä¸ºç©º
5. âš ï¸ ç¡®è®¤ `tenantUsername` ä¸ä¸ºç©º

## ğŸ§ª å¿«é€Ÿæµ‹è¯•

```powershell
# ç™»å½•
$login = Invoke-WebRequest -Uri "http://localhost:8080/api/auth/login" `
    -Method POST -ContentType "application/json" `
    -Body '{"username":"admin","password":"admin123"}' `
    -SessionVariable session

# è·å–æ‰€æœ‰ç§Ÿçº¦
$leases = Invoke-WebRequest -Uri "http://localhost:8080/api/leases" `
    -Method GET -WebSession $session

$result = $leases.Content | ConvertFrom-Json
Write-Host "æ€»ç§Ÿçº¦æ•°: $($result.totalElements)"
Write-Host "ç¬¬ä¸€æ¡ç‰©ä¸š: $($result.content[0].propertyAddress)"
Write-Host "ç¬¬ä¸€æ¡ç§Ÿå®¢: $($result.content[0].tenantUsername)"
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **Controller**: `LeaseController.java` âœ“
- **Service**: `LeaseService.java` âœ“
- **Repository**: `LeaseRepository.java` âœ“ (å·²æ·»åŠ EntityGraph)
- **DTO**: `LeaseDto.java` âœ“
- **Mapper**: `LeaseMapper.java` âœ“

## ğŸ‰ æ€»ç»“

**ç§Ÿçº¦è®°å½•"ç›´æ¥æ˜¾ç¤º"åŠŸèƒ½å·²å®Œå…¨å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼**

æ ¸å¿ƒç‰¹ç‚¹ï¼š
1. âœ… **é›¶é…ç½®**: å‰ç«¯ç›´æ¥è°ƒç”¨ `GET /api/leases`ï¼Œæ— éœ€ä¼ å‚
2. âœ… **æ™ºèƒ½è¿‡æ»¤**: åç«¯æ ¹æ®ç”¨æˆ·è§’è‰²è‡ªåŠ¨è¿”å›ç›¸åº”æ•°æ®
3. âœ… **å®Œæ•´ä¿¡æ¯**: åŒ…å«ç‰©ä¸šåœ°å€å’Œç§Ÿå®¢ç”¨æˆ·å
4. âœ… **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ EntityGraph é¿å… N+1 æŸ¥è¯¢
5. âœ… **æµ‹è¯•é€šè¿‡**: APIè¿”å›æ­£ç¡®æ•°æ®ï¼Œä¸æ•°æ®åº“ä¸€è‡´

**æµ‹è¯•ç»“æœ**: 
- æ•°æ®åº“æœ‰ 16 æ¡ç§Ÿçº¦
- API æ­£ç¡®è¿”å› 16 æ¡ç§Ÿçº¦
- åŒ…å«å®Œæ•´çš„ç‰©ä¸šåœ°å€å’Œç§Ÿå®¢ä¿¡æ¯

åŠŸèƒ½å·²å°±ç»ªï¼Œé‡å¯åº”ç”¨å³å¯ä½¿ç”¨ï¼ğŸš€
