# 文件管理系统功能说明

## 概述

文件管理系统为智慧物业管理平台提供完整的文件上传、存储、管理和访问功能，支持物业图片、租约合同、维修图片等多种文件类型的管理。

**开发日期**: 2025-10-14  
**版本**: v1.0

---

## 功能特性

### ✅ 核心功能

1. **文件上传**
   - 支持多文件上传
   - 文件类型验证（图片、PDF等）
   - 文件大小限制（可配置）
   - 自动生成唯一文件名
   - 按分类存储到不同目录

2. **文件分类**
   - `PROPERTY_IMAGE` - 物业图片
   - `LEASE_CONTRACT` - 租约合同
   - `MAINTENANCE_IMAGE` - 维修图片
   - `USER_AVATAR` - 用户头像
   - `OTHER` - 其他文件

3. **文件访问**
   - 在线预览（图片、PDF）
   - 文件下载
   - 权限控制

4. **文件管理**
   - 文件列表查询
   - 文件详情查看
   - 文件删除（磁盘+数据库）
   - 文件统计

5. **物业封面图片**
   - 设置物业封面图片
   - 自动取消旧封面
   - 封面图片查询

---

## 技术架构

### 后端架构

```
┌─────────────────────────────────────────┐
│          FileController (API层)          │
│  - 文件上传                               │
│  - 文件下载/预览                          │
│  - 文件查询/删除                          │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────┴───────────────────────┐
│          FileService (业务层)            │
│  - 文件验证（类型、大小）                 │
│  - 文件存储（本地磁盘）                   │
│  - 封面管理                               │
│  - 文件查询                               │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────┴───────────────────────┐
│      FileRepository (数据访问层)         │
│  - 文件元数据CRUD                         │
│  - 按分类/实体查询                        │
│  - 文件统计                               │
└─────────────────────────────────────────┘
```

### 前端架构

```
┌─────────────────────────────────────────┐
│      FileUpload (通用上传组件)           │
│  - 文件选择                               │
│  - 上传进度                               │
│  - 预览/删除                              │
│  - v-model双向绑定                        │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────┴───────────────────────┐
│         业务页面集成                      │
│  - PropertiesView (物业图片)             │
│  - LeasesView (租约合同)                 │
│  - MaintenanceView (维修图片)            │
└─────────────────────────────────────────┘
```

---

## 数据库设计

### files 表

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| original_file_name | VARCHAR(255) | 原始文件名 |
| stored_file_name | VARCHAR(255) | 存储文件名（唯一） |
| file_path | VARCHAR(500) | 文件路径 |
| file_type | VARCHAR(100) | MIME类型 |
| file_size | BIGINT | 文件大小（字节） |
| category | VARCHAR(50) | 文件分类 |
| entity_id | BIGINT | 关联实体ID |
| is_cover | BOOLEAN | 是否为封面 |
| description | VARCHAR(500) | 文件描述 |
| uploaded_by | BIGINT | 上传用户ID |
| uploaded_at | DATETIME | 上传时间 |
| updated_at | DATETIME | 更新时间 |

---

## API接口文档

### 1. 文件上传

**接口**: `POST /api/files/upload`

**请求参数** (multipart/form-data):
- `file` (File, 必需) - 上传的文件
- `category` (String, 必需) - 文件分类
- `entityId` (Long, 可选) - 关联实体ID
- `description` (String, 可选) - 文件描述

**响应示例**:
```json
{
  "success": true,
  "message": "文件上传成功",
  "file": {
    "id": 1,
    "originalFileName": "house1.jpg",
    "storedFileName": "uuid-xxxxx.jpg",
    "filePath": "properties/uuid-xxxxx.jpg",
    "fileType": "image/jpeg",
    "fileSize": 1048576,
    "category": "PROPERTY_IMAGE",
    "entityId": 1,
    "isCover": false,
    "uploadedBy": 2,
    "uploadedAt": "2025-10-14T12:00:00"
  }
}
```

### 2. 文件下载

**接口**: `GET /api/files/download/{fileName}`

**说明**: 下载文件（attachment方式）

### 3. 文件预览

**接口**: `GET /api/files/preview/{fileName}`

**说明**: 在线预览文件（inline方式）

### 4. 获取文件详情

**接口**: `GET /api/files/{fileId}`

**响应**: 文件对象

### 5. 获取实体的文件列表

**接口**: `GET /api/files/entity/{category}/{entityId}`

**响应**: 文件数组

### 6. 获取封面图片

**接口**: `GET /api/files/cover/{propertyId}`

**响应**: 封面图片对象

### 7. 设置封面图片

**接口**: `PUT /api/files/{fileId}/set-cover?propertyId={propertyId}`

### 8. 删除文件

**接口**: `DELETE /api/files/{fileId}`

### 9. 统计文件数量

**接口**: `GET /api/files/count/{category}/{entityId}`

---

## 配置说明

### application.properties

```properties
# 文件存储配置
file.storage.upload-dir=uploads
file.storage.max-file-size=10485760
file.storage.max-image-size=5242880
file.storage.max-document-size=10485760

# Spring文件上传配置
spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB
```

### 文件大小限制

- **图片文件**: 最大 5MB
- **文档文件**: 最大 10MB

### 支持的文件类型

**图片类型**:
- image/jpeg
- image/jpg
- image/png
- image/gif
- image/webp

**文档类型**:
- application/pdf
- application/msword
- application/vnd.openxmlformats-officedocument.wordprocessingml.document

---

## 文件存储结构

```
uploads/
├── properties/      # 物业图片
│   ├── uuid-1.jpg
│   ├── uuid-2.png
│   └── ...
├── contracts/       # 租约合同
│   ├── uuid-3.pdf
│   └── ...
├── maintenance/     # 维修图片
│   ├── uuid-4.jpg
│   └── ...
├── avatars/         # 用户头像
│   └── ...
└── others/          # 其他文件
    └── ...
```

---

## 前端组件使用

### FileUpload 组件

**基本用法**:

```vue
<template>
  <FileUpload
    v-model="images"
    category="PROPERTY_IMAGE"
    :entity-id="propertyId"
    :limit="10"
    accept="image/*"
    @upload-success="handleSuccess"
  />
</template>

<script setup>
import { ref } from 'vue'
import FileUpload from '@/components/FileUpload.vue'

const images = ref([])
const propertyId = ref(1)

function handleSuccess(file) {
  console.log('上传成功:', file)
}
</script>
```

**Props**:

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| category | String | - | 文件分类（必需） |
| entityId | Number/String | null | 关联实体ID |
| modelValue | Array | [] | 文件列表（v-model） |
| listType | String | 'picture-card' | 列表类型 |
| multiple | Boolean | true | 是否支持多选 |
| limit | Number | 5 | 最大上传数量 |
| accept | String | 'image/*' | 接受的文件类型 |
| buttonText | String | '点击上传' | 按钮文字 |
| tipText | String | - | 提示文字 |
| showTip | Boolean | true | 是否显示提示 |
| disabled | Boolean | false | 是否禁用 |

**Events**:

- `update:modelValue` - 文件列表更新
- `upload-success` - 上传成功
- `upload-error` - 上传失败
- `remove` - 文件移除

---

## 测试说明

### 测试页面

访问路径: `/file-upload-test`

### 测试步骤

1. **登录系统**
   - 使用管理员或业主账号登录

2. **访问测试页面**
   - 导航到文件上传测试页面

3. **测试物业图片上传**
   - 选择1-10张图片
   - 点击上传
   - 查看上传进度和结果
   - 点击图片预览
   - 删除测试

4. **测试租约合同上传**
   - 选择PDF文件
   - 上传并预览

5. **测试维修图片上传**
   - 选择图片上传
   - 验证功能正常

---

## 安全性

### 文件验证

1. **文件类型验证**
   - 检查MIME类型
   - 根据分类限制文件类型

2. **文件大小验证**
   - 前后端双重验证
   - 根据文件类型设置不同限制

3. **文件名安全**
   - 使用UUID生成唯一文件名
   - 防止路径遍历攻击
   - 清理非法字符

4. **权限控制**
   - 需要登录才能上传
   - 只能删除自己上传的文件
   - 访问控制待完善

---

## 后续优化计划

### 功能优化

- [ ] 集成阿里云OSS或MinIO对象存储
- [ ] 添加图片压缩功能
- [ ] 添加图片水印功能
- [ ] 支持断点续传
- [ ] 支持文件秒传（MD5去重）

### 性能优化

- [ ] 添加文件缓存机制
- [ ] CDN加速支持
- [ ] 图片懒加载
- [ ] 缩略图生成

### 安全优化

- [ ] 更严格的权限控制
- [ ] 文件病毒扫描
- [ ] 防盗链
- [ ] 访问日志记录

---

## 常见问题

### 1. 上传失败怎么办？

**可能原因**:
- 文件大小超过限制
- 文件类型不支持
- 网络问题
- 后端服务未启动

**解决方法**:
- 检查文件大小和类型
- 查看浏览器控制台错误信息
- 检查后端日志

### 2. 无法预览图片？

**可能原因**:
- 文件路径不正确
- 后端服务未启动
- 文件已被删除

**解决方法**:
- 检查文件是否存在于uploads目录
- 检查后端API是否正常响应

### 3. 上传的文件存储在哪里？

文件存储在后端项目的 `uploads/` 目录下，按分类存储到不同的子目录。

---

## 版本历史

### v1.0 (2025-10-14)

**新增功能**:
- ✅ 文件上传功能
- ✅ 文件下载和预览
- ✅ 文件管理（查询、删除）
- ✅ 封面图片管理
- ✅ 前端上传组件
- ✅ 测试页面

**文件清单**:

后端:
- `model/File.java` - 文件实体
- `model/FileCategory.java` - 文件分类枚举
- `repository/FileRepository.java` - 数据访问层
- `service/FileService.java` - 业务逻辑层
- `controller/FileController.java` - API接口层
- `config/FileStorageConfig.java` - 配置类

前端:
- `components/FileUpload.vue` - 文件上传组件
- `views/FileUploadTest.vue` - 测试页面

---

**文档维护者**: Development Team  
**最后更新**: 2025-10-14
