# æ”¶æ”¯è®°å½•åŠŸèƒ½ - æœ€ç»ˆç¡®è®¤è¯´æ˜

## âœ… æ ¸å¿ƒåŠŸèƒ½ï¼š"ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰è®°å½•"

### åŠŸèƒ½æè¿°
ç‚¹å‡»"æ”¶æ”¯è®°å½•"èœå•åï¼Œ**æ— éœ€ä»»ä½•å‚æ•°**ï¼Œå³å¯ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰å¯è§çš„æ”¶æ”¯è®°å½•ã€‚

### APIç«¯ç‚¹
```
GET /api/payments
```

### å®ç°ç»†èŠ‚

#### 1. æ— éœ€å¿…å¡«å‚æ•°
- **æ— å‚æ•°è°ƒç”¨**: `GET /api/payments?page=0&size=20`
- **è‡ªåŠ¨æ˜¾ç¤º**: ç³»ç»Ÿæ ¹æ®å½“å‰ç™»å½•ç”¨æˆ·çš„è§’è‰²è‡ªåŠ¨æ˜¾ç¤ºç›¸åº”çš„è®°å½•

#### 2. æ™ºèƒ½æƒé™è¿‡æ»¤
| ç”¨æˆ·è§’è‰² | çœ‹åˆ°çš„è®°å½• |
|---------|-----------|
| ç®¡ç†å‘˜ (ROLE_ADMIN) | æ‰€æœ‰64æ¡æ”¶æ”¯è®°å½• |
| ä¸šä¸» (ROLE_OWNER) | åªçœ‹è‡ªå·±ç‰©ä¸šç›¸å…³çš„æ”¶æ”¯ |
| ç§Ÿå®¢ (ROLE_TENANT) | åªçœ‹è‡ªå·±ç§Ÿçº¦çš„æ”¶æ”¯ |

#### 3. å®Œæ•´çš„ä¿¡æ¯
æ¯æ¡æ”¶æ”¯è®°å½•åŒ…å«ï¼š
- âœ… æ”¶æ”¯ID
- âœ… ç§Ÿçº¦ID  
- âœ… **ç‰©ä¸šåœ°å€** (æ–°å¢)
- âœ… **ç§Ÿå®¢å§“å** (æ–°å¢)
- âœ… é‡‘é¢
- âœ… æ”¯ä»˜æ—¥æœŸ
- âœ… æ”¯ä»˜æ–¹å¼
- âœ… åˆ›å»ºæ—¶é—´

#### 4. å¯é€‰çš„ç­›é€‰åŠŸèƒ½
å¦‚æœéœ€è¦æŒ‰ç§Ÿçº¦ç­›é€‰ï¼Œå¯ä»¥æ·»åŠ å‚æ•°ï¼š
```
GET /api/payments?leaseId=1
```

## ğŸ¯ å‰ç«¯é›†æˆ

### ä¸»é¡µé¢åŠ è½½
```javascript
// ç”¨æˆ·ç‚¹å‡»"æ”¶æ”¯è®°å½•"èœå•æ—¶
function loadPayments() {
    fetch('/api/payments?page=0&size=20')
        .then(response => response.json())
        .then(data => {
            // data.content - æ‰€æœ‰å¯è§çš„æ”¶æ”¯è®°å½•
            // data.totalElements - æ€»è®°å½•æ•°
            // data.totalPages - æ€»é¡µæ•°
            displayPayments(data.content);
        });
}
```

### å“åº”ç¤ºä¾‹
```json
{
  "content": [
    {
      "id": 1,
      "leaseId": 1,
      "propertyAddress": "åŒ—äº¬å¸‚æœé˜³åŒºxxxå°åŒº1å·æ¥¼101å®¤",
      "tenantName": "å¼ ä¸‰",
      "amount": 2500.00,
      "paymentDate": "2024-06-05",
      "paymentMethod": "é“¶è¡Œè½¬è´¦",
      "createdAt": "2024-06-05T10:30:00Z"
    }
  ],
  "currentPage": 0,
  "totalPages": 13,
  "totalElements": 64,
  "pageSize": 5
}
```

### æ·»åŠ ç­›é€‰åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
```javascript
// å¦‚æœå‰ç«¯éœ€è¦æŒ‰ç§Ÿçº¦ç­›é€‰
function filterByLease(leaseId) {
    fetch(`/api/payments?leaseId=${leaseId}&page=0&size=20`)
        .then(response => response.json())
        .then(data => {
            displayPayments(data.content);
        });
}
```

## ğŸ“ ä»£ç å®ç°ç¡®è®¤

### Controller (å·²ç¡®è®¤ âœ“)
```java
@GetMapping
public ResponseEntity<PageResponse<PaymentDto>> getAllPayments(
        @RequestParam(required = false) Long leaseId,  // â† å¯é€‰å‚æ•°
        @PageableDefault Pageable pageable) {
    if (leaseId != null) {
        // æœ‰å‚æ•° -> ç­›é€‰
        return ResponseEntity.ok(paymentService.getPaymentsByLease(leaseId, pageable));
    }
    // æ— å‚æ•° -> æ˜¾ç¤ºæ‰€æœ‰ï¼ˆæ ¹æ®è§’è‰²è¿‡æ»¤ï¼‰
    return ResponseEntity.ok(paymentService.getAllPayments(pageable));
}
```

### Service (å·²ç¡®è®¤ âœ“)
```java
public PageResponse<PaymentDto> getAllPayments(Pageable pageable) {
    UserPrincipal principal = getCurrentUser();
    Page<Payment> page;
    
    if (isAdmin(principal)) {
        page = paymentRepository.findAll(pageable);
    } else if (isOwner(principal)) {
        page = paymentRepository.findAllByLeasePropertyOwnerId(principal.getId(), pageable);
    } else {
        page = paymentRepository.findAllByLeaseTenantId(principal.getId(), pageable);
    }
    
    return PageResponse.from(page.map(PaymentMapper::toDto));
}
```

### Repository (å·²ç¡®è®¤ âœ“)
```java
// ä½¿ç”¨ @EntityGraph ä¸€æ¬¡æ€§åŠ è½½å…³è”æ•°æ®
@EntityGraph(attributePaths = {"lease", "lease.property", "lease.tenant"})
Page<Payment> findAll(Pageable pageable);
```

## âš ï¸ é‡è¦æç¤º

### å¿…é¡»é‡å¯åº”ç”¨
æ‰€æœ‰ä»£ç ä¿®æ”¹å®Œæˆåï¼Œ**å¿…é¡»é‡å¯Spring Bootåº”ç”¨**æ‰èƒ½ç”Ÿæ•ˆï¼

```bash
# æ–¹å¼1: Maven
mvn spring-boot:run

# æ–¹å¼2: Java
java -jar target/property-management-0.0.1-SNAPSHOT.jar
```

### éªŒè¯æ¸…å•
- [x] ä»£ç å·²ç¼–è¯‘æˆåŠŸ
- [ ] åº”ç”¨å·²é‡å¯
- [ ] `GET /api/payments` è¿”å›æ•°æ®
- [ ] `propertyAddress` ä¸ä¸ºç©º
- [ ] `tenantName` ä¸ä¸ºç©º
- [ ] `GET /api/payments?leaseId=1` ç­›é€‰æ­£ç¡®

## ğŸ§ª å¿«é€Ÿæµ‹è¯•

```powershell
# 1. ç™»å½•
$login = Invoke-WebRequest -Uri "http://localhost:8080/api/auth/login" `
    -Method POST -ContentType "application/json" `
    -Body '{"username":"admin","password":"admin123"}' `
    -SessionVariable session

# 2. è·å–æ‰€æœ‰æ”¶æ”¯ï¼ˆæ— å‚æ•°ï¼‰
$all = Invoke-WebRequest -Uri "http://localhost:8080/api/payments" `
    -Method GET -WebSession $session

$result = $all.Content | ConvertFrom-Json
Write-Host "æ€»è®°å½•æ•°: $($result.totalElements)"
Write-Host "ç¬¬ä¸€æ¡ç‰©ä¸šåœ°å€: $($result.content[0].propertyAddress)"
Write-Host "ç¬¬ä¸€æ¡ç§Ÿå®¢: $($result.content[0].tenantName)"

# 3. æŒ‰ç§Ÿçº¦ç­›é€‰
$leaseId = $result.content[0].leaseId
$filtered = Invoke-WebRequest -Uri "http://localhost:8080/api/payments?leaseId=$leaseId" `
    -Method GET -WebSession $session

$filteredResult = $filtered.Content | ConvertFrom-Json
Write-Host "ç­›é€‰åè®°å½•æ•°: $($filteredResult.totalElements)"
```

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | æ—§å®ç° | æ–°å®ç° |
|-----|-------|-------|
| æŸ¥è¯¢æ–¹å¼ | å¿…é¡»æä¾› leaseId | **æ— éœ€å‚æ•°ï¼Œç›´æ¥æŸ¥è¯¢** |
| æƒé™æ§åˆ¶ | æ‰‹åŠ¨æ£€æŸ¥ | **è‡ªåŠ¨æ ¹æ®è§’è‰²è¿‡æ»¤** |
| æ•°æ®å®Œæ•´æ€§ | åªæœ‰åŸºæœ¬ä¿¡æ¯ | **åŒ…å«ç‰©ä¸šåœ°å€å’Œç§Ÿå®¢å§“å** |
| ç­›é€‰åŠŸèƒ½ | âŒ æ—  | âœ… å¯é€‰çš„ leaseId ç­›é€‰ |
| æ€§èƒ½ä¼˜åŒ– | N+1 æŸ¥è¯¢é—®é¢˜ | âœ… ä½¿ç”¨ EntityGraph |

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **Controller**: `PaymentController.java` âœ“
- **Service**: `PaymentService.java` âœ“  
- **Repository**: `PaymentRepository.java` âœ“
- **DTO**: `PaymentDto.java` âœ“
- **Mapper**: `PaymentMapper.java` âœ“

## ğŸ‰ æ€»ç»“

**"ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰è®°å½•"åŠŸèƒ½å·²å®Œå…¨å®ç°ï¼**

æ ¸å¿ƒç‰¹ç‚¹ï¼š
1. âœ… **é›¶é…ç½®**: å‰ç«¯ç›´æ¥è°ƒç”¨ `GET /api/payments`ï¼Œæ— éœ€ä¼ å‚
2. âœ… **æ™ºèƒ½è¿‡æ»¤**: åç«¯æ ¹æ®ç”¨æˆ·è§’è‰²è‡ªåŠ¨è¿”å›ç›¸åº”æ•°æ®
3. âœ… **å®Œæ•´ä¿¡æ¯**: åŒ…å«ç‰©ä¸šåœ°å€å’Œç§Ÿå®¢å§“åï¼Œæ— éœ€äºŒæ¬¡æŸ¥è¯¢
4. âœ… **çµæ´»æ‰©å±•**: æ”¯æŒå¯é€‰çš„ `leaseId` å‚æ•°è¿›è¡Œç­›é€‰
5. âœ… **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ EntityGraph é¿å… N+1 æŸ¥è¯¢

**åªéœ€é‡å¯åº”ç”¨ï¼ŒåŠŸèƒ½å³å¯ä½¿ç”¨ï¼** ğŸš€
