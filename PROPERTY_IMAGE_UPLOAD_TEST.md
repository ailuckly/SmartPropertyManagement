# 物业图片上传功能 - 测试指南

> 创建时间：2025-10-14 15:30
> 状态：✅ 已完成集成

---

## 🎉 功能完成情况

### ✅ 已实现的功能

1. **图片上传组件集成**
   - ✅ 在物业表单中添加了 FileUpload 组件
   - ✅ 支持最多 10 张图片上传
   - ✅ 支持 jpg/png/gif 格式
   - ✅ 单个文件不超过 5MB

2. **实时预览**
   - ✅ 选择图片时立即显示本地预览
   - ✅ 上传成功后显示服务器图片
   - ✅ 自动释放 blob URL

3. **图片管理**
   - ✅ 图片网格展示
   - ✅ 封面图片设置（点击图片）
   - ✅ 封面标识（绿色边框 + 标签）
   - ✅ 图片预览功能（点击放大）

4. **编辑模式**
   - ✅ 编辑物业时自动加载已上传图片
   - ✅ 可以继续上传新图片
   - ✅ 可以删除已上传图片

---

## 🧪 测试步骤

### 第一步：启动服务

```bash
# 后端（在 backend 目录）
cd E:\University\Henan-University-of-Technology\2025-09\courseExperimentProject\CourseDesign\backend
.\mvnw spring-boot:run

# 前端（在 frontend 目录，新窗口）
cd E:\University\Henan-University-of-Technology\2025-09\courseExperimentProject\CourseDesign\frontend
npm run dev
```

### 第二步：登录系统

```
访问: http://localhost:5173
登录账号: admin / admin123 (或其他账号)
```

### 第三步：创建新物业并上传图片

1. **点击"新建物业"按钮**
2. **填写物业基本信息**
   - 详细地址：北京市朝阳区三里屯路
   - 城市：北京
   - 省/州：北京
   - 邮编：100027
   - 物业类型：公寓
   - 卧室数量：2
   - 卫生间数量：1
   - 面积：85㎡
   - 月租：8500元
   - 状态：可出租

3. **上传物业图片**
   - 点击"物业图片"区域的上传按钮
   - 选择 1-10 张图片
   - ✅ **观察实时预览**：选择图片后立即显示预览
   - ✅ **观察上传进度**：显示"上传中"状态
   - ✅ **观察上传成功**：显示服务器图片

4. **保存物业**
   - 点击"创建物业"按钮
   - ✅ 成功提示："物业创建成功"

5. **验证图片已保存**
   - 在物业列表找到刚创建的物业
   - 点击"编辑"按钮
   - ✅ 应该能看到之前上传的所有图片

### 第四步：设置封面图片

1. **在编辑模式下**
2. **在"图片管理"区域**
   - 看到提示："点击图片可设置为封面"
3. **点击任意一张图片**
   - ✅ 该图片边框变为绿色（3px）
   - ✅ 右上角显示"封面"标签
   - ✅ 提示："封面设置成功"
4. **点击另一张图片**
   - ✅ 之前的封面标识消失
   - ✅ 新图片变为封面

### 第五步：图片预览和删除

1. **预览图片**
   - 在图片缩略图上点击（不触发封面设置）
   - ✅ 弹出大图预览窗口

2. **删除图片**
   - 在 FileUpload 组件中悬停图片
   - 点击删除按钮
   - ✅ 图片从列表中移除
   - ✅ 提示："文件删除成功"

---

## 📝 详细功能说明

### 1. 图片上传流程

```
用户选择图片
    ↓
立即显示本地预览（blob URL）
    ↓
自动上传到服务器
    ↓
上传成功
    ↓
释放 blob URL
    ↓
替换为服务器图片 URL
    ↓
图片保存在数据库（关联 propertyId）
```

### 2. 封面设置逻辑

```
点击图片
    ↓
检查是否已保存物业（editingId 存在）
    ↓
调用 API: PUT /api/files/{fileId}/set-cover
    ↓
后端：取消当前封面，设置新封面
    ↓
前端：重新加载图片列表
    ↓
UI 更新：显示新封面标识
```

### 3. 编辑模式加载图片

```
点击"编辑"按钮
    ↓
startEdit() 函数执行
    ↓
loadPropertyImages(propertyId) 加载图片
    ↓
API: GET /api/files/entity/PROPERTY_IMAGE/{propertyId}
    ↓
form.images 更新
    ↓
FileUpload 组件显示已有图片
```

---

## 🎨 UI 展示效果

### FileUpload 组件
```
┌─────────────────────────────────────┐
│  [+]  [+]  [+]  [+]  [+]            │  ← 上传区域
│                                     │
│  提示：支持jpg/png/gif格式，         │
│        单个文件不超过5MB，最多10张   │
└─────────────────────────────────────┘
```

### 图片管理区域
```
┌─────────────────────────────────────┐
│  ℹ️  点击图片可设置为封面             │
├─────────────────────────────────────┤
│  ┌─────┐  ┌─────┐  ┌─────┐          │
│  │ 🏠  │  │ 🏠  │  │ 🏠  │  ← 图片   │
│  │     │  │[封面]│  │     │           │
│  └─────┘  └─────┘  └─────┘          │
│   普通    封面（绿框）  普通           │
└─────────────────────────────────────┘
```

---

## 🐛 常见问题

### Q1: 图片上传后看不到预览？
**A:** 检查以下几点：
1. 后端服务是否运行（端口 8080）
2. 浏览器控制台是否有错误
3. 检查预览 URL 是否正确
4. 确认 CORS 配置正确

### Q2: 设置封面时提示"请先保存物业"？
**A:** 封面设置需要 propertyId，请先：
1. 保存物业基本信息
2. 在编辑模式下上传图片
3. 然后才能设置封面

### Q3: 图片上传成功但刷新后消失？
**A:** 检查：
1. 文件是否真的上传到服务器
2. 检查 `backend/uploads/properties/` 目录
3. 查看数据库 `file` 表是否有记录
4. 确认 `entityId` 是否正确关联

### Q4: 新建物业时能上传图片吗？
**A:** 可以！但有两种方式：
- **方式1（推荐）：** 先保存物业基本信息，然后编辑时上传图片
- **方式2：** 新建时上传图片，FileUpload 组件会在保存物业后自动关联

---

## ✅ 验收标准

### 基本功能
- [ ] 可以在创建物业时上传图片
- [ ] 可以在编辑物业时上传图片
- [ ] 可以删除已上传的图片
- [ ] 支持最多 10 张图片
- [ ] 图片大小限制（5MB）正常工作

### 高级功能
- [ ] 选择图片时立即显示本地预览
- [ ] 上传成功后切换到服务器图片
- [ ] 可以设置封面图片
- [ ] 封面标识清晰可见（绿色边框 + 标签）
- [ ] 点击图片可以放大预览

### 交互体验
- [ ] 上传过程有进度提示
- [ ] 成功/失败有明确提示
- [ ] 图片加载有 loading 状态
- [ ] 响应速度快（< 2秒）

---

## 📊 技术实现细节

### 涉及的文件

**前端：**
- `frontend/src/views/PropertiesView.vue` - 主要修改
- `frontend/src/components/FileUpload.vue` - 通用组件

**后端：**
- `backend/src/main/java/...controller/FileController.java` - 文件接口
- `backend/src/main/java/...service/FileService.java` - 文件服务
- `backend/uploads/properties/` - 图片存储目录

### API 接口使用

```javascript
// 上传文件
POST /api/files/upload
body: FormData { file, category: 'PROPERTY_IMAGE', entityId }

// 获取物业图片
GET /api/files/entity/PROPERTY_IMAGE/{propertyId}

// 预览图片
GET /api/files/preview/{storedFileName}

// 设置封面
PUT /api/files/{fileId}/set-cover?propertyId={propertyId}

// 删除文件
DELETE /api/files/{fileId}
```

---

## 🚀 下一步

物业图片上传功能已完成！现在可以继续集成其他模块：

1. ⏳ **维修管理 - 问题图片上传**
2. ⏳ **租约管理 - 合同文件上传**
3. ⏳ **用户资料 - 头像上传**

---

## 📸 测试截图建议

建议截图记录以下场景：
1. 新建物业 - 图片上传界面
2. 图片实时预览效果
3. 图片管理 - 封面设置
4. 编辑物业 - 加载已有图片
5. 图片预览大图效果

---

**测试人员：** _________
**测试日期：** 2025-10-14
**测试结果：** [ ] 通过  [ ] 失败

**备注：**
_______________________________________
_______________________________________
